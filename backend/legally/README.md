# Legally

Legally — сервис для автоматизированного анализа юридических PDF-документов с помощью LLM. Приложение выделяет риски, формирует рекомендации, ведёт историю анализов в MongoDB и поддерживает административный модуль для пополнения базы знаний (RAG).

## Основные возможности
- Загрузка PDF-документов и извлечение текста с разбивкой на части и обработкой ошибок.
- Анализ содержимого через OpenRouter (DeepSeek) с формированием структурированного отчёта.
- Хранение истории анализов и пользовательских данных в MongoDB, просмотр истории и повторное использование результатов.
- JWT-аутентификация с refresh-токенами, валидация и выход пользователя, очистка временных данных и отмена долгих операций.
- Модуль RAG для управления юридической базой знаний: загрузка документов, поиск, статистика и повторная генерация эмбеддингов.
- Веб-интерфейсы для пользователей (`/`) и администраторов (`/static/admin.html`), сервируемые напрямую из папки `public`.

## Структура проекта
- `main.go` — запуск приложения, инициализация переменных окружения, MongoDB и HTTP-сервера Gin.
- `api/controllers` — обработчики публичных, пользовательских и административных REST-эндпоинтов.
- `api/middleware` — CORS, логирование и JWT-авторизация с проверкой роли (`user`/`admin`).
- `services/` — бизнес-логика (анализ документов, работа с RAG, аутентификация и управление кэшем).
- `repositories/` — доступ к MongoDB для историй анализов и RAG-документов.
- `models/` — структуры данных (пользователь, анализ, RAG-документ, запросы к API).
- `db/` — подключение к MongoDB и утилиты для получения коллекций.
- `utils/` — вспомогательные функции: работа с PDF, JWT, логированием, строками и прогресс-барами.
- `public/` — статические ресурсы пользовательского и административного интерфейсов.
- `temp/` — временное хранилище для обрабатываемых PDF (создаётся автоматически).

## Технологический стек
- Go 1.24+, Gin, MongoDB Driver, bcrypt, jwt-go.
- LLM: OpenRouter (`deepseek/deepseek-r1-0528:free`) для анализа документов.
- Embeddings: OpenAI `text-embedding-ada-002` (при отсутствии ключа используется псевдо-эмбеддинг для разработки).
- Frontend: ванильный JS + Marked + highlight.js (статически сервируется).

## Предварительные требования
- Go 1.24 или выше.
- Доступ к MongoDB (локально или в облаке).
- Ключ `OPENROUTER_API_KEY` для OpenRouter.
- Ключ `OPENAI_API_KEY` (опционально, но рекомендуется для генерации реальных эмбеддингов RAG).
- Настроенные секреты JWT.

## Настройка окружения
1. Склонируйте репозиторий и перейдите в каталог проекта.
2. Создайте файл `.env` (не коммитьте реальные секреты в VCS) и заполните его переменными из таблицы ниже.
3. Установите зависимости:
   ```bash
   go mod download
   ```
4. Убедитесь, что MongoDB доступна по указанному `MONGO_URI`, а директория `temp/` доступна для записи (при необходимости создаётся автоматически).

### Переменные окружения
| Переменная            | Обязательна | По умолчанию | Описание |
|-----------------------|-------------|--------------|----------|
| `MONGO_URI`           | Да          | —            | Строка подключения к MongoDB (используется БД `legally`). |
| `OPENROUTER_API_KEY`  | Да          | —            | Ключ OpenRouter для обращения к модели анализа. |
| `OPENAI_API_KEY`      | Нет*        | —            | Ключ OpenAI для генерации эмбеддингов RAG. При отсутствии используется упрощённый вектор. |
| `JWT_SECRET`          | Да          | —            | Секрет для подписания access-токена. |
| `JWT_REFRESH_SECRET`  | Да          | —            | Секрет для подписания refresh-токена. |
| `PORT`                | Нет         | `8081`       | Порт HTTP-сервера Gin. |
| `REDIS_ADDR`          | Нет         | —            | Зарезервировано под кэш Redis (не используется). |
| `SWAGGER_HOST`        | Нет         | —            | Зарезервировано под Swagger (не используется). |

\* Для полноценной работы административного модуля рекомендуется задать реальный `OPENAI_API_KEY`.

## Запуск локально
```bash
go run .
# или
go run main.go
```

По умолчанию сервис доступен на `http://localhost:8081`.  
Пользовательский интерфейс открыт на `/`, административный — на `/static/admin.html` (требуется токен администратора).

## Работа с данными и файлами
- Временные файлы сохраняются в `./temp` и удаляются после извлечения текста.
- История анализов хранится в коллекции `analyses`, документы RAG — в `rag_documents`, пользователи — в `users`.
- Логирование (включая служебные сообщения и ошибки) ведётся в stdout, сообщения в основном на русском языке.

## API
Базовый URL: `{{baseUrl}} = http://localhost:8081` (или другой порт, указанный в `PORT`).

### Публичные эндпоинты
| Метод | URL                    | Описание                                  | Авторизация | Тело запроса |
|-------|------------------------|-------------------------------------------|-------------|--------------|
| GET   | `/health`              | Проверка доступности сервиса и MongoDB.   | Нет         | —            |
| POST  | `/api/register`        | Регистрация пользователя (`email`, `password`). | Нет | JSON `{ "email": "...", "password": "..." }` |
| POST  | `/api/login`           | Аутентификация пользователя.              | Нет         | JSON `{ "email": "...", "password": "..." }` |
| POST  | `/api/refresh`         | Обновление пары токенов по refresh-токену.| Нет         | JSON `{ "refreshToken": "..." }` |
| GET   | `/api/validate-token`  | Быстрая проверка access-токена.           | `Bearer`    | —            |
| GET   | `/api/laws`            | Получение списка релевантных нормативных актов. | Нет | — |

### Пользовательские эндпоинты (требуется роль `user`)
| Метод | URL                     | Описание                                           | Авторизация | Тело запроса |
|-------|-------------------------|----------------------------------------------------|-------------|--------------|
| POST  | `/api/analyze`          | Запуск анализа PDF. Тело: `multipart/form-data`, поле `document` (PDF ≤ 10 MB). | `Bearer` | Форм-данные |
| GET   | `/api/history`          | История анализов текущего пользователя (макс. 50 записей). | `Bearer` | — |
| GET   | `/api/user`             | Профиль и роль текущего пользователя.              | `Bearer` | — |
| POST  | `/api/logout`           | Заготовка для выхода (очистка на клиенте).         | `Bearer` | — |
| POST  | `/api/analysis/cancel`  | Попытка отменить активный анализ (если выполняется). | `Bearer` | — |
| POST  | `/api/cache/clear`      | Очистка кэша загруженных файлов пользователя.      | `Bearer` | — |

### Административные эндпоинты (требуется роль `admin`)
> ⚠️ В `api/routes.go` для группы `/api/admin` оставлен TODO: необходимые маршруты нужно добавить вручную, чтобы эндпоинты стали доступными из коробки. Фронтенд `/static/admin.html` ожидает именно их.

| Метод | URL                                   | Описание | Авторизация | Тело запроса |
|-------|---------------------------------------|----------|-------------|--------------|
| POST  | `/api/admin/rag/upload`               | Загрузка PDF в базу знаний (`title`, `category`, опционально `source`, файл `document`). | `Bearer` (admin) | `multipart/form-data` |
| POST  | `/api/admin/rag/search`               | Поиск по RAG-коллекции по тексту и категории. | `Bearer` (admin) | JSON `{ "query": "...", "category": "", "limit": 10 }` |
| GET   | `/api/admin/rag/documents`            | Список документов с пагинацией (`limit`, `offset`, `category`). | `Bearer` (admin) | — |
| DELETE| `/api/admin/rag/documents/{id}`       | Удаление документа по ObjectID. | `Bearer` (admin) | — |
| POST  | `/api/admin/rag/documents/{id}/reprocess` | Повторная обработка документа (генерация эмбеддингов). | `Bearer` (admin) | — |
| GET   | `/api/admin/rag/stats`                | Статистика по RAG-документам (по статусам и категориям). | `Bearer` (admin) | — |
| GET   | `/api/admin/rag/categories`           | Справочник категорий документов. | `Bearer` (admin) | — |

## Postman-коллекция
Готовая коллекция с примерами запросов находится в `docs/Legally.postman_collection.json`.  
Импортируйте файл в Postman и скорректируйте значения переменных коллекции:
- `baseUrl` — адрес запущенного сервиса.
- `userAccessToken`, `refreshToken` — будут заполнены автоматически после успешного запроса `/api/login`.
- `adminAccessToken` — задайте вручную (или обновите роль пользователя в MongoDB).
- `documentId` — используйте ObjectID существующего RAG-документа для запросов удаления/повторной обработки.

## Известные ограничения и дальнейшие шаги
- Административные маршруты необходимо подключить в `api/routes.go` (см. комментарий TODO).
- Redis, Swagger и другие переменные зарезервированы для будущих улучшений.
- Добавьте автоматические тесты (`go test ./...`) и CI по мере развития проекта.
