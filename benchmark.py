# benchmark.py — бенчмарк Legal RAG для РК: Accuracy, Faithfulness, ROUGE (LegalBench-адапт.)

import time
import json
import re
import pandas as pd
from datetime import datetime
from pathlib import Path
import signal
import os

import config
from rag_chain import qa_chain

# Индексы вопросов-ловушек (1-based): ожидается ответ "Информация не найдена..."
# В текущем списке: блок "81–90" (NFT 2035, льготы 2040, НДС 2035 и т.д.)
TRAP_QUESTION_INDICES = set(range(31, 41))  # подстрой под свой список при 50+ вопросах
NOT_FOUND_PHRASES = ("не найдена", "не найден", "тапсырмада жоқ", "информация не найдена")
DISCLAIMER_PHRASES = ("не официальная юридическая консультация", "ресми заңдық кеңес емес")

# ======================
# 50 вопросов — идеально сбалансированные
# ======================
questions = [
    # # 1–10: Прямые (что говорит статья, принципы)
    # "Какие основные принципы трудового законодательства Республики Казахстан?",
    # "Что говорит Гражданский кодекс о договоре купли-продажи?",
    # "Что такое договор дарения в Гражданском кодексе?",
    # "Какие виды наказаний предусмотрены УК РК?",
    # "Что такое административное правонарушение?",
    # "Какие права ребёнка по Кодексу о браке и семье?",
    # "Что говорит Налоговый кодекс о сроках уплаты НДС?",
    # "Что такое МӘМС и кто платит взносы?",
    # "Каковы требования к регистрации ИП?",
    # "Что такое ГЧП и какие его принципы?",
    #
    # # 11–20: Фактические (сроки, размеры, права/обязанности)
    # "Сколько лет нужно платить алименты на ребёнка?",
    # "Какова стандартная продолжительность ежегодного оплачиваемого трудового отпуска?",
    # "Каков максимальный испытательный срок по ТК РК?",
    # "Сколько составляет МРП в 2026 году?",
    # "Какова базовая ставка КПН для юридических лиц?",
    # "Каковы сроки исковой давности по гражданским делам?",
    # "Сколько составляет штраф за нарушение ПДД (общий случай)?",
    # "Каковы сроки уплаты подоходного налога для физлиц?",
    # "Какой минимальный размер пособия по беременности и родам?",
    # "Каков максимальный срок договора ГЧП?",
    #
    # # 21–30: Сравнительные (отличия)
    # "В чем отличие перевода работника к другому работодателю от временного перевода?",
    # "В чем разница между СНР на патенте и СНР с фиксированным вычетом?",
    # "В чем отличие между пенсией по возрасту и государственной социальной помощью?",
    # "В чем разница между ГОБМП и МӘМС?",
    # "В чем отличие договора ГЧП от договора аренды государственного имущества?",
    # "В чем разница между административным арестом и лишением свободы?",
    # "В чем отличие между ИПН и КПН?",
    # "В чем разница между полной и неполной занятостью?",
    # "В чем отличие между приватизацией и выкупом служебного жилья?",
    # "В чем разница между государственной образовательной субсидией и грантом?",
    #
    # # 31–40: На казахском языке
    # "Еңбек кодексінде жүкті әйелдердің құқықтары қандай?",
    # "Қызметкердің өз еркімен жұмыстан кетуі үшін қанша мерзім бұрын ескерту қажет?",
    # "Жалақыны төлеудің ең соңғы мерзімі қашан?",
    # "Мемлекеттік мереке күндері жұмыс істегені үшін ақы қандай мөлшерде төленеді?",
    # "Жұмыс беруші қызметкерді сынақ мерзімі кезінде жұмыстан шығаруға құқылы ма?",
    # "Қандай жағдайларда жұмыс беруші қызметкерді медициналық тексеруден өткізуге міндетті?",
    # "Қандай салық режимдерінде бухгалтерлік есеп міндетті емес?",
    # "Жеке кәсіпкердің қызметін тоқтату үшін қандай құжаттар қажет?",
    # "Қандай жағдайларда әкімшілік айыппұлды 50% жеңілдікпен төлеуге болады?",
    # "ҚР-да зейнеткерлік жас қандай?",
    #
    # # 41–50: Ловушки (без ответа в базе → "Информация не найдена")
    # "Сколько составляет минимальная зарплата в 2030 году?",
    # "Что говорит УК РК о краже автомобиля за 5 млн тенге в 2027 году?",
    # "Какие льготы для пенсионеров в 2028 году?",
    # "Какова ставка НДС в 2025 году?",
    # "Что говорит Трудовой кодекс о работе в выходные в 2026 году?",
    # "Какие штрафы за превышение скорости на 40 км/ч в 2027 году?",
    # "Какова процедура развода в 2030 году?",
    # "Сколько лет платят алименты на ребёнка после 2030 года?",
    # "Какие права у ИП в 2028 году?",
    # "Что говорит Гражданский кодекс о криптовалюте?"

    # 51–60: Сложные многоступенчатые сценарии (применение норм к фактам)
    "Работник был принят на работу с испытательным сроком 3 месяца. Через 2 месяца он получил производственную травму и был на больничном 45 дней. Можно ли его уволить по результатам испытания?",
    "Супруги в браке 10 лет, есть несовершеннолетний ребёнок. Один из супругов хочет развестись, но второй против. Как будет делиться совместно нажитое имущество, если один из супругов докажет, что вложил личные деньги в квартиру?",
    "ИП на упрощёнке получил доход 500 млн тенге за год. В следующем году он планирует нанять 10 сотрудников. Какой налоговый режим ему выгоднее выбрать и почему?",
    "Беременная женщина работает на вредном производстве. Работодатель предлагает временный перевод на другую работу с понижением зарплаты. Имеет ли она право отказаться и что будет, если она откажется?",
    "Гражданин взял кредит в банке под залог квартиры. Через год он не платит. Банк хочет забрать квартиру. Какие права у заёмщика и каков порядок обращения взыскания?",
    "Работник совершил прогул, работодатель уволил его по статье. Работник подал в суд, утверждая, что был на больничном. Как суд должен рассматривать дело и какие доказательства нужны?",
    "Женщина родила ребёнка вне брака. Отец ребёнка признаёт отцовство, но алименты не платит. Как взыскать алименты, если отец не работает официально?",
    "Компания заключила договор ГЧП на строительство школы. Через 5 лет подрядчик не выполнил обязательства. Кто несёт ответственность и как расторгнуть договор?",
    "Гражданин получил травму на производстве, но работодатель не составил акт. Как доказать факт травмы и получить компенсацию?",
    "ИП на патенте продал товар на 200 млн тенге. Нужно ли ему переходить на общий режим и платить НДС?",

    # 61–70: Гипотетические ситуации + применение норм
    "Работодатель заставляет беременную женщину работать ночью. Что она может сделать и какое наказание ждёт работодателя?",
    "Супруг продал совместно нажитую квартиру без согласия жены. Может ли жена оспорить сделку и в какой срок?",
    "ИП не заплатил социальные отчисления за себя за 3 года. Какие штрафы и пени ему начислят?",
    "Работник получил травму на работе, но был в состоянии алкогольного опьянения. Получит ли он компенсацию?",
    "Гражданин взял ипотеку, но потерял работу. Может ли банк забрать квартиру сразу?",
    "Мать-одиночка не получает алименты от отца ребёнка. Как взыскать долг за прошлые 5 лет?",
    "Компания не выплатила зарплату за 3 месяца. Какие меры может принять работник и в какие органы обращаться?",
    "Гражданин купил квартиру, но обнаружил скрытые дефекты. В какой срок и как можно расторгнуть договор?",
    #"Работодатель уволил работника за прогул, но тот был на больничном. Как доказать факт болезни в суде?",
    "ИП на упрощёнке нанял 15 сотрудников. Когда и как он должен перейти на другой налоговый режим?",

    # 71–80: На казахском языке (сложные сценарии)
    "Жұмыс беруші жүкті әйелді түнде жұмысқа тартуға құқылы ма және ол бас тартса не болады?",
    "Ерлі-зайыптылар 8 жыл некеде тұрды, ортақ мүлік бар. Біреуі некені бұзғысы келеді, екіншісі қарсы. Ортақ мүлік қалай бөлінеді?",
    "ЖК патент негізінде жұмыс істеді, жылдық табысы 600 млн теңге болды. Келесі жылы 12 қызметкер алмақшы. Қандай салық режимі тиімді?",
    "Жүкті әйел зиянды өндірісте жұмыс істейді. Жұмыс беруші басқа жұмысқа ауыстыруды ұсынады, бірақ жалақы төмендейді. Ол бас тарта ала ма?",
    "Азамат банкте несие алды, кепілге пәтер қойды. 1 жылдан кейін төлемейді. Банк пәтерді қалай алады?",
    "Қызметкер жұмыста мас күйде жарақат алды. Ол өтемақы ала ма?",
    "Ана жалғыз тәрбиелейді, әке алимент төлемейді. 5 жылғы қарызды қалай өндіріп алады?",
    "Компания мектеп салу үшін МЖӘ келісімшартын жасады. 5 жылдан кейін мердігер міндеттемені орындамады. Келісімшартты қалай бұзады?",
    "Қызметкер жарақат алды, бірақ акт жасалмады. Жарақатты қалай дәлелдейді және өтемақы алады ма?",
    "ЖК упрощёнкада 15 қызметкер алды. Қашан және қалай басқа салық режиміне көшуі керек?",

    # 81–90: Ловушки + гипотетические (будущее, несуществующие нормы)
    "Что говорит УК РК о краже NFT в 2035 году?",
    "Какие льготы для пенсионеров в 2040 году?",
    "Какова ставка НДС в 2035 году?",
    "Что говорит Трудовой кодекс о работе в метавселенной?",
    "Какие штрафы за превышение скорости дронами в 2032 году?",
    "Какова процедура развода онлайн в 2040 году?",
    "Сколько лет платят алименты на ребёнка после 2050 года?",
    "Какие права у ИП в эпоху ИИ в 2045 году?",
    "Что говорит Гражданский кодекс о правах на нейросети?",
    "Каковы сроки исковой давности по спорам о криптовалюте в 2030 году?",

    # 91–100: Сложные + многоступенчатые (применение нескольких норм)
    "Работник получил травму, работодатель не составил акт, а потом уволил за прогул. Какие права у работника и куда обращаться?",
    "Супруги развелись, есть ребёнок-инвалид. Как делится имущество и кто платит алименты?",
    "ИП на патенте нанял 20 сотрудников и заработал 1 млрд тенге. Что ему грозит и как перейти на общий режим?",
    "Беременная женщина отказалась от ночных смен. Работодатель хочет её уволить. Законно ли это и что она может сделать?",
    "Гражданин взял ипотеку, потерял работу, не платит 6 месяцев. Банк хочет забрать квартиру. Какие права у заёмщика?",
    "Мать не получает алименты 4 года. Отец официально не работает. Как взыскать долг и пеню?",
    "Компания не выплатила зарплату 4 месяца. Работники бастуют. Какие права у работников и что грозит работодателю?",
    "Покупатель купил квартиру с скрытыми дефектами. Продавец отказывается возвращать деньги. В какой срок и куда обращаться?",
    "Работодатель уволил по сокращению, но не выплатил компенсацию. Как взыскать деньги через суд?",
    "ИП на упрощёнке получил доход 800 млн тенге. Нужно ли платить НДС и как перейти на другой режим?"

]

# ======================
# Таймаут-функция
# ======================
def timeout_handler(signum, frame):
    raise TimeoutError("Запрос занял слишком много времени")

# ======================
# Запуск бенчмарка
# ======================
results = []

print(f"Запуск бенчмарка: {len(questions)} вопросов\n")

for idx, question in enumerate(questions, 1):
    print(f"[{idx}/{len(questions)}] Вопрос: {question}")
    start_time = time.time()

    signal.signal(signal.SIGALRM, timeout_handler)
    signal.alarm(300)  # 5 минут

    try:
        result = qa_chain.invoke({"query": question})
        response = result["result"]
        sources_list = [doc.metadata.get('source', 'неизвестно') for doc in result["source_documents"]]
        sources = ", ".join(set(sources_list)) if sources_list else "Нет источников"
        duration = round(time.time() - start_time, 2)

        results.append({
            "№": idx,
            "Вопрос": question,
            "Ответ": response,
            "Источники": sources,
            "Время (сек)": duration,
            "Правильность": "",          # ← Да / Нет / Частично
            "Галлюцинация": "",          # ← Да / Нет
            "Комментарий": ""
        })

        print(f"Время: {duration} сек")
        print(f"Ответ (первые 300 символов): {response[:300]}...")
        print("-" * 100)

    except TimeoutError:
        duration = round(time.time() - start_time, 2)
        results.append({
            "№": idx,
            "Вопрос": question,
            "Ответ": "ТАЙМАУТ (>5 мин)",
            "Источники": "",
            "Время (сек)": duration,
            "Правильность": "",
            "Галлюцинация": "",
            "Комментарий": "Зависание — проверь Ollama / RAM"
        })
        print("ТАЙМАУТ — пропуск вопроса")
        print("-" * 100)

    except Exception as e:
        duration = round(time.time() - start_time, 2)
        results.append({
            "№": idx,
            "Вопрос": question,
            "Ответ": f"ОШИБКА: {str(e)}",
            "Источники": "",
            "Время (сек)": duration,
            "Правильность": "",
            "Галлюцинация": "",
            "Комментарий": ""
        })
        print(f"Ошибка: {e}")
        print("-" * 100)

    finally:
        signal.alarm(0)

# ======================
# Сохранение результатов
# ======================
config.BENCHMARK_DIR.mkdir(parents=True, exist_ok=True)
timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M")
excel_file = str(config.BENCHMARK_DIR / f"legal_rag_benchmark_{timestamp}.xlsx")
json_file = str(config.BENCHMARK_DIR / f"legal_rag_benchmark_{timestamp}.json")
metrics_file = str(config.BENCHMARK_DIR / f"legal_rag_metrics_{timestamp}.json")

# Excel
df = pd.DataFrame(results)
df.to_excel(excel_file, index=False, engine='openpyxl')

# JSON
with open(json_file, 'w', encoding='utf-8') as f:
    json.dump(results, f, ensure_ascii=False, indent=2)

# ======================
# Автоматические метрики (Accuracy, Faithfulness, ROUGE)
# ======================
def _has_not_found(text):
    if not text or not isinstance(text, str):
        return False
    t = text.lower()
    return any(p in t for p in NOT_FOUND_PHRASES)

def _has_disclaimer(text):
    if not text or not isinstance(text, str):
        return False
    t = text.lower()
    return any(p in t for p in DISCLAIMER_PHRASES)

# Точность на ловушках: для trap-вопросов правильный ответ — "не найдена"
trap_results = [r for i, r in enumerate(results, 1) if i in TRAP_QUESTION_INDICES]
trap_correct = sum(1 for r in trap_results if _has_not_found(r.get("Ответ", "")))
trap_accuracy = (trap_correct / len(trap_results) * 100) if trap_results else 0.0

# Faithfulness (эвристика): есть дисклеймер + для нетрапов не пустой ответ; для трапов — "не найдена"
with_disclaimer = sum(1 for r in results if _has_disclaimer(r.get("Ответ", "")))
faithfulness_heuristic = (with_disclaimer / len(results) * 100) if results else 0.0

# Доля ответов "не найдена" (ожидаемо для ловушек)
not_found_count = sum(1 for r in results if _has_not_found(r.get("Ответ", "")))
not_found_pct = (not_found_count / len(results) * 100) if results else 0.0

# Автозаполнение колонки для ловушек (для Excel)
for i, r in enumerate(results):
    idx = i + 1
    if idx in TRAP_QUESTION_INDICES:
        r["Авто_ловушка"] = "Да" if _has_not_found(r.get("Ответ", "")) else "Нет"
    else:
        r["Авто_ловушка"] = "—"

avg_time = sum(r.get("Время (сек)", 0) for r in results) / len(results) if results else 0

# ROUGE-L (если есть эталоны)
rouge_l_scores = []
references_path = config.BASE_DIR / "benchmark_references.json"
if references_path.exists():
    try:
        from rouge_score import rouge_scorer
        with open(references_path, "r", encoding="utf-8") as f:
            refs = json.load(f)
        scorer = rouge_scorer.RougeScorer(["rougeL"], use_stemmer=False)
        for i, r in enumerate(results):
            ref = refs.get(str(i + 1)) or refs.get(str(r.get("№", i + 1)))
            if ref and r.get("Ответ") and "ОШИБКА" not in str(r.get("Ответ", "")):
                score = scorer.score(ref, r["Ответ"])
                rouge_l_scores.append(score["rougeL"].fmeasure)
        rouge_l_avg = sum(rouge_l_scores) / len(rouge_l_scores) * 100 if rouge_l_scores else None
    except Exception as e:
        rouge_l_avg = None
else:
    rouge_l_avg = None

metrics = {
    "timestamp": timestamp,
    "n_questions": len(results),
    "trap_accuracy_pct": round(trap_accuracy, 1),
    "faithfulness_heuristic_pct": round(faithfulness_heuristic, 1),
    "not_found_pct": round(not_found_pct, 1),
    "avg_time_sec": round(avg_time, 2),
    "rouge_l_pct": round(rouge_l_avg, 2) if rouge_l_avg is not None else None,
}
with open(metrics_file, "w", encoding="utf-8") as f:
    json.dump(metrics, f, ensure_ascii=False, indent=2)

# Перезаписываем Excel с новой колонкой Авто_ловушка
df = pd.DataFrame(results)
df.to_excel(excel_file, index=False, engine='openpyxl')

print(f"\nБенчмарк завершён!")
print(f"Сохранено: Excel {excel_file}, JSON {json_file}, метрики {metrics_file}")
print(f"Обработано вопросов: {len(results)}")
print("\n--- Автоматические метрики ---")
print(f"Точность на ловушках (trap accuracy): {trap_accuracy:.1f}%")
print(f"Faithfulness (дисклеймер): {faithfulness_heuristic:.1f}%")
print(f"% ответов «Информация не найдена»: {not_found_pct:.1f}%")
print(f"Среднее время ответа: {avg_time:.1f} сек")
if rouge_l_avg is not None:
    print(f"ROUGE-L (по эталонам): {rouge_l_avg:.2f}%")
print("\nДля полной Accuracy/Faithfulness заполните в Excel колонки 'Правильность' и 'Галлюцинация' и пересчитайте.")