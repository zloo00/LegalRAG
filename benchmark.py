# benchmark.py — оценка Legal RAG по фиксированным вопросам (RU/KZ)

"""
Запуск: python benchmark.py

Вопросы задаются в BENCHMARK_QUESTIONS ниже.
Результаты сохраняются в benchmark_results/ (JSON + Excel).
"""

import json
import os
import sys
import time
from datetime import datetime
from pathlib import Path

import config

# Папка для результатов
config.BENCHMARK_DIR.mkdir(parents=True, exist_ok=True)

# Вопросы для бенчмарка (id, вопрос, язык)
BENCHMARK_QUESTIONS = [
#     {
#         "id": "aslan_illegal_business_kz",
#         "query": """Мәселенің мәні:
#
# Аслан – шағын кәсіпкер, қалада құрылыс материалдарын сатумен айналысады. Ол салықтық жүктемені азайту үшін ресми тіркелмей, яғни лицензиясыз және салық органдарына есеп бермей, ірі көлемде құрылыс материалдарын сатып алып, қайта сатады.
# Бір жыл ішінде Асланның айналымы 500 миллион теңгеден асады, бірақ ол табысын жасырып, салық төлемейді. Мемлекеттік кірістер комитеті жүргізген тексеріс барысында заңсыз кәсіпкерлік қызметінің дәлелдері анықталады.
#
# І. Құқықтық талдау:
# Сұрақ:1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына  құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
# 2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
# 3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар?Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
# 4. Қандай қылмыстық жауапкершілік қарастырылған?
# 5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
#         "lang": "kz",
#         "description": "Лицензиясыз тіркелмей ірі көлемде сауда жасау, салық төлемеу (заңсыз кәсіпкерлік, УК РК)",
#     },
    {
        "id": "gabyt_pyramid_kz",
        "query": """Мәселенің мәні:

Ғабит жеке кәсіпкер ретінде “KazProfit” атты инвестициялық компанияны ашады. Ол азаматтарға “жоғары пайда әкелетін инвестиция” ұсынатынын айтып, ай сайын 30-50% табыс беретінін жарнамалайды.
Клиенттер компанияға 5 000 000 теңгеден бастап инвестиция салады, бірақ компанияның нақты экономикалық қызметі жоқ. Ғабит жаңа клиенттерден түскен қаражаттың бір бөлігін ескі салымшыларға пайыз ретінде төлеп, қалған ақшаны жеке қажеттіліктеріне жұмсайды.
Бір жылдан кейін жаңа салымшылардың ағымы азайып, компания қаржылық міндеттемелерін орындай алмайды. Нәтижесінде 500-ден астам азамат жалпы сомасы 1 миллиард теңгеден аса қаражатынан айырылады. Жәбірленушілер құқық қорғау органдарына арыз түсіреді, ал тергеу барысында “KazProfit” қаржылық пирамида ретінде жұмыс істегені анықталады.

І. Құқықтық талдау:
Сұрақ:1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына  құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар?Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
4. Қандай қылмыстық жауапкершілік қарастырылған?
5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
        "lang": "kz",
        "description": "Қаржылық пирамида (инвестиция уәде, төлемдер жаңа салымнан, ірі залал)",
    },
    {
        "id": "criminal_case_kz_1",
        "query": """Сұрақ:
1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар? Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
4. Қандай қылмыстық жауапкершілік қарастырылған?
5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
        "lang": "kz",
        "description": "Қылмыстық кейс бойынша талдау (УК РК, құрам, жаза)",
    }
#     {
#         "id": "labor_principles_ru",
#         "query": "Какие основные принципы трудового законодательства Республики Казахстан?",
#         "lang": "ru",
#         "description": "Принципы трудового законодательства (ТК РК)",
#     },
#     {
#         "id": "criminal_minors_ru",
#         "query": "Какая ответственность по УК РК за преступления против несовершеннолетних (ст. 120–135 УК РК)?",
#         "lang": "ru",
#         "description": "Преступления против несовершеннолетних, УК РК",
#     },
#
#     {
#     "id": "midwife_case_kz",
#     "query": """Мәселенің мәні: Акушерка Амандықова босану бөлімінде жаңа туған екі нәрестенің білезіктерін қасақана ауыстырып, оларды әртүрлі отбасыларға береді. Бұл әрекеттің мақсаты — белгілі бір отбасына ұл бала беру арқылы материалдық сыйақы алу.
#
# І. Құқықтық талдау:
# Сұрақ:1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
# 2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
# 3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар? Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
# 4. Қандай қылмыстық жауапкершілік қарастырылған?
# 5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
#     "lang": "kz",
#     "description": "Акушерка нәрестелердің білезіктерін ауыстыру (балаларды ауыстыру, УК РК)",
# },
# {
#         "id": "kasenov_child_neglect_kz",
#         "query": """Мәселенің мәні:
# Азамат Касенов өзінің 10 жасар ұлы Марлен-ды тәрбиелеу және күтіп-бағу міндеттерін орындамайды. Ол баласына қажетті тамақ, киім-кешек, медициналық көмек көрсетпейді, сондай-ақ оның білім алуына кедергі жасайды. Соның салдарынан бала денсаулығы мен дамуына зиян келеді.
#
# І. Құқықтық талдау:
# Сұрақ:1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
# 2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
# 3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар? Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
# 4. Қандай қылмыстық жауапкершілік қарастырылған?
# 5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
#         "lang": "kz",
#         "description": "Ата-ана тәрбие міндеттерін орындамау (ст. 140 УК РК)",
#     },
#     {
#         "id": "e_child_selling_kz",
#         "query": """Мәселенің мәні:
# 25 жастағы азамат Е. қаржылық пайда табу мақсатында 14 жастағы жасөспірім Ж.-ны үшінші тұлғаларға заңсыз жұмысқа орналастыру үшін сатқан.
#
# І. Құқықтық талдау:
# Сұрақ:1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
# 2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
# 3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар? Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
# 4. Қандай қылмыстық жауапкершілік қарастырылған?
# 5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
#         "lang": "kz",
#         "description": "14 жасар баланы жұмысқа сату (ст. 135 УК РК)",
#     },
#     {
#         "id": "nark_group_kz",
#         "query": """Мәселенің мәні:
# Мұрат, Асқар және Жандос есірткі заттарын заңсыз сатумен айналысатын ұйымдасқан топ құрды. Мұрат топтың жетекшісі болып, есірткі жеткізушілермен келісім жасаған, Асқар заттарды бөлшектеп сатып отырған, ал Жандос сатып алушылармен байланысқа шығып, тапсырыстарды қабылдаған. Полиция оларды ұзақ уақыт бақылап, қылмыс үстінде ұстады.
#
# І. Құқықтық талдау:
# Сұрақ:1. Кейс бойынша қылмыстық құқық бұзушылықтың құрамы бар жоқтығына құқықтық талдау жасап оны тиісті НҚА сілтеме жасап негіздеңіз.
# 2. Кейс бойынша қылмыстық құқық бұзушылық әрекеті қандай қылмысқа жатады?
# 3. Кейс бойынша қылмыстық құқық бұзушылық әрекетінде қандай қылмыстың құрамы бар? Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетінде ауырлататын және жеңілдететін жағдайлары қандай?
# 4. Қандай қылмыстық жауапкершілік қарастырылған?
# 5. Кейс бойынша қылмыстық құқық бұзушылық іс-әрекетін ескере отырып, қандай жаза тағайындалады?""",
#         "lang": "kz",
#         "description": "Ұйымдасқан топпен есірткі сату (ст. 297 УК РК)",
#     }
]


def run_benchmark(timeout_sec: float = None):
    timeout_sec = timeout_sec or getattr(config, "BENCHMARK_TIMEOUT_SEC", 300)

    print("Загрузка RAG-цепи...")
    try:
        from rag_chain import qa_chain
    except Exception as e:
        print(f"Ошибка загрузки rag_chain: {e}")
        sys.exit(1)

    results = []
    print(f"\nБенчмарк: {len(BENCHMARK_QUESTIONS)} вопросов, таймаут {timeout_sec} с\n")

    for i, item in enumerate(BENCHMARK_QUESTIONS, 1):
        qid = item["id"]
        query = item["query"]
        lang = item.get("lang", "ru")
        desc = item.get("description", "")

        print(f"[{i}/{len(BENCHMARK_QUESTIONS)}] {qid} ({lang}) — {desc or query[:60]}...")

        start = time.perf_counter()
        try:
            result = qa_chain.invoke({"query": query})
            elapsed = time.perf_counter() - start
        except Exception as e:
            elapsed = time.perf_counter() - start
            result = {"result": f"[Ошибка: {e}]", "source_documents": []}
            print(f"   Ошибка: {e}")

        answer = result.get("result", "")
        sources = result.get("source_documents", [])

        row = {
            "id": qid,
            "query": query,
            "lang": lang,
            "description": desc,
            "answer": answer,
            "answer_length": len(answer),
            "sources_count": len(sources),
            "time_sec": round(elapsed, 2),
            "sources": [
                {
                    "source": d.metadata.get("source", ""),
                    "code_ru": d.metadata.get("code_ru", ""),
                    "article_number": d.metadata.get("article_number", ""),
                    "preview": d.page_content[:200].replace("\n", " "),
                }
                for d in sources
            ],
        }
        results.append(row)
        print(f"   Ответ: {len(answer)} символов, источников: {len(sources)}, время: {row['time_sec']} с")

    # Сохранение
    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M")
    name_base = f"legal_rag_benchmark_{timestamp}"

    json_path = config.BENCHMARK_DIR / f"{name_base}.json"
    with open(json_path, "w", encoding="utf-8") as f:
        json.dump(
            {
                "timestamp": timestamp,
                "questions_count": len(results),
                "results": results,
            },
            f,
            ensure_ascii=False,
            indent=2,
        )
    print(f"\nРезультаты сохранены: {json_path}")

    # Excel (если есть pandas)
    try:
        import pandas as pd

        df = pd.DataFrame(
            [
                {
                    "id": r["id"],
                    "lang": r["lang"],
                    "description": r["description"],
                    "query": r["query"][:500],
                    "answer": r["answer"],
                    "sources_count": r["sources_count"],
                    "time_sec": r["time_sec"],
                }
                for r in results
            ]
        )
        excel_path = config.BENCHMARK_DIR / f"{name_base}.xlsx"
        df.to_excel(excel_path, index=False, engine="openpyxl")
        print(f"Excel сохранён: {excel_path}")
    except ImportError:
        print("pandas/openpyxl не установлены — Excel не создан")

    # Краткая сводка
    avg_time = sum(r["time_sec"] for r in results) / len(results) if results else 0
    print(f"\nИтого: {len(results)} вопросов, среднее время ответа: {avg_time:.1f} с")
    return results


if __name__ == "__main__":
    run_benchmark()
